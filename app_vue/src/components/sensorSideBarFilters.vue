<script setup>
  import { reactive, ref, watch } from 'vue'
  import { useSensorStore } from '@/stores/sensors_store';
  import { useRouteStore } from '@/stores/route_store';
  import { storeToRefs } from 'pinia';

  const thresholdRange = ref([0,100]);

  // route store
  const routeStore = useRouteStore();

  // sensor store
  const sensorStore = useSensorStore();
  const { 
    sensors, 
    getAllGroupOptions,
    getAllAssetTags,
    getAllBinTypes,
    getAllBinVolumes,
    getAllMaterialTypes } = storeToRefs(sensorStore);

  // component reactive variables
  const state = reactive({
    selectedGroup: null,
    selectedAssetTag: [],
    selectedBinType: [],
    selectedBinVolume: null,
    selectedFillRange: [0, 100],
    selectedMaterialType: [],
    group: [],
    assetTag: [],
    binType: [],
    binVolume: [],
    materialType: [],
    totalSensors: 0,
    showFillLabel: false
  });

  // watching for store state updates and updating component variables
  watch(sensors, () => {
    state.totalSensors = sensorStore.getTotalSensors;
  })

  watch(getAllGroupOptions, () => {
    state.group = sensorStore.getAllGroupOptions;
  })

  watch(getAllAssetTags, () => {
    state.assetTag = sensorStore.getAllAssetTags;
  })

  watch(getAllBinTypes, () => {
    state.binType = sensorStore.getAllBinTypes;
  })

  watch(getAllBinVolumes, () => {
    state.binVolume = sensorStore.getAllBinVolumes;
  })

  watch(getAllMaterialTypes, () => {
    state.materialType = sensorStore.getAllMaterialTypes;
  })

  function updateSensorsShown() {
    routeStore.clearSensorRoute();
    sensorStore.updateSensorsWithFilters();
  }

  // when change event is received from form, update sensor store
  function updateGroupFilter() {
    sensorStore.setSelectedGroup(state.selectedGroup);
    updateSensorsShown();
  }

  function updateAssetTagFilter() {
    sensorStore.setSelectedAssetTag(state.selectedAssetTag);
    updateSensorsShown();
  }

  function updateBinTypeFilter() {
    sensorStore.setSelectedBinType(state.selectedBinType);
    updateSensorsShown();
  }

  function updateBinVolumeFilter() {
    sensorStore.setSelectedBinVolume(state.selectedBinVolume);
    updateSensorsShown();
  }

  function updateFillRangeFilter() {
    sensorStore.setSelectedFillRange(state.selectedFillRange);
    updateSensorsShown();
  }

  function updateMaterialTypeFilter() {
    sensorStore.setSelectedMaterialType(state.selectedMaterialType);
    updateSensorsShown();
  }

  function clearFilters() {
    sensorStore.clearSelected(); // clear store of selected values
    // clear v-models in form
    state.selectedGroup = null;
    state.selectedAssetTag = [];
    state.selectedBinType = null;
    state.selectedBinVolume = null;
    state.selectedFillRange = [0, 100];
    state.selectedMaterialType = [];
  }

</script>

<template>
  <section class="filter-list">
    <div class="text-h6 padding-b-30 d-flex align-center">
      <span>Filter Sensors ({{ state.totalSensors }})</span> 
      <span class="mx-3">|</span>
      <v-btn variant="plain" color="#2196F3" class="pa-0 pt-1 text-capitalize" @click="clearFilters">Clear</v-btn>
    </div>
    
    <div class="filter-list__fill-level">
      <div class="filter-list__label color-gray-grey">Fill Level Threshold</div>
      <v-range-slider class="filter-list__slider" 
        v-model="state.selectedFillRange"
        strict
        color="#2196F3"
        track-color="#2196F3"
        :ticks="[0,50,100]"
        show-ticks="always"
        tick-size="4"
        :step="1"
        :max="thresholdRange[1]"
        :min="thresholdRange[0]"
        :thumb-label="state.showFillLabel"
        @mouseup="state.showFillLabel = false"
        @mousedown="state.showFillLabel = true"
        @update:modelValue="updateFillRangeFilter">
        <template v-slot:thumb-label="{ modelValue }">
          {{modelValue}}%
        </template>
      </v-range-slider>
    </div>

    <v-autocomplete class="filter-list__dropdown"
      v-model="state.selectedGroup"
      label="Group"
      :items="state.group"
      @update:modelValue="updateGroupFilter"
    ></v-autocomplete>

    <v-autocomplete class="filter-list__dropdown"
      v-model="state.selectedAssetTag"
      label="Asset Tag"
      chips
      multiple
      :items="state.assetTag"
      @update:modelValue="updateAssetTagFilter"
    ></v-autocomplete>

    <v-autocomplete class="filter-list__dropdown"
      v-model="state.selectedBinType"
      label="Bin Type"
      chips
      multiple
      :items="state.binType"
      @update:modelValue="updateBinTypeFilter"
    ></v-autocomplete>

    <v-autocomplete class="filter-list__dropdown"
      v-model="state.selectedBinVolume"
      label="Bin Volume"
      :items="state.binVolume"
      @update:modelValue="updateBinVolumeFilter"
    ></v-autocomplete>

    <v-autocomplete class="filter-list__dropdown"
      v-model="state.selectedMaterialType"
      label="Material Type"
      chips
      multiple
      :items="state.materialType"
      @update:modelValue="updateMaterialTypeFilter"
    ></v-autocomplete>

  </section>
</template>

<style lang="scss" scoped>

  // vuetify overrides
  :deep .v-field--variant-filled .v-field__overlay { // vue select background
    background-color: white;
  }

  :deep .v-slider-thumb__surface { // slider size
    width: 12px;
    height: 12px;
  }

  :deep .v-input__details { // input padding size
    min-height: 14px;
  }
  
  .filter-list {
    width: 100%;

    &__label {
      @include fontBody;
    }
  }

</style>
